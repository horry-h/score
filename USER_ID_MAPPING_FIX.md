# ç”¨æˆ·IDå­—æ®µæ˜ å°„é—®é¢˜ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

ç”¨æˆ·ä¿å­˜ç”¨æˆ·ä¿¡æ¯åï¼Œå†æ¬¡ç‚¹å‡»åˆ›å»ºæˆ¿é—´ä»ç„¶å¼¹å‡ºç”¨æˆ·ä¿¡æ¯æµ®çª—ï¼Œæ— æ³•æ­£å¸¸è¿›å…¥åˆ›å»ºæˆ¿é—´é¡µé¢ã€‚

## é—®é¢˜åˆ†æ

### é”™è¯¯åŸå› 

**å­—æ®µæ˜ å°„ä¸ä¸€è‡´**: åç«¯è¿”å›çš„ç”¨æˆ·ä¿¡æ¯ä¸­ï¼Œç”¨æˆ·IDå­—æ®µæ˜¯`id`ï¼Œä½†å‰ç«¯ä»£ç ä¸­æ£€æŸ¥çš„æ˜¯`user_id`ã€‚

### å…·ä½“é—®é¢˜

1. **åç«¯è¿”å›æ•°æ®ç»“æ„**:
   ```json
   {
     "id": 1,
     "openid": "mock_openid_1234",
     "nickname": "æµ‹è¯•ç”¨æˆ·",
     "avatar_url": "https://example.com/avatar.jpg",
     "created_at": 1694000000,
     "updated_at": 1694000000
   }
   ```

2. **å‰ç«¯æ£€æŸ¥é€»è¾‘**:
   ```javascript
   // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
   const userInfo = app.globalData.userInfo || wx.getStorageSync('userInfo')
   if (!userInfo || !userInfo.user_id) { // âŒ æ£€æŸ¥user_idï¼Œä½†åç«¯è¿”å›çš„æ˜¯id
     this.showLoginModal()
     return
   }
   ```

3. **é—®é¢˜ç»“æœ**:
   - ç”¨æˆ·ä¿¡æ¯ä¿å­˜æˆåŠŸ
   - ä½†`userInfo.user_id`ä¸º`undefined`
   - ç‚¹å‡»åˆ›å»ºæˆ¿é—´æ—¶ï¼Œæ£€æŸ¥`!userInfo.user_id`ä¸º`true`
   - ä»ç„¶å¼¹å‡ºç™»å½•æµ®çª—

## è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ç­–ç•¥

åœ¨ä¿å­˜ç”¨æˆ·ä¿¡æ¯æ—¶ï¼Œæ·»åŠ `user_id`å­—æ®µï¼Œå°†åç«¯è¿”å›çš„`id`æ˜ å°„ä¸º`user_id`ã€‚

### ä¿®å¤å†…å®¹

#### 1. ä¿®å¤app.jsä¸­çš„loginæ–¹æ³•

**ä¿®æ”¹å‰**:
```javascript
const userData = {
  ...response.data,
  nickName: nickname,
  avatarUrl: avatarUrl
}
```

**ä¿®æ”¹å**:
```javascript
const userData = {
  ...response.data,
  user_id: response.data.id, // æ·»åŠ user_idå­—æ®µï¼Œä½¿ç”¨åç«¯è¿”å›çš„id
  nickName: nickname,
  avatarUrl: avatarUrl
}
```

#### 2. ä¿®å¤index.jsä¸­çš„saveUserInfoæ–¹æ³•

**ä¿®æ”¹å‰**:
```javascript
const updatedUserInfo = {
  ...loginRes,
  nickname: nickname,
  avatarUrl: avatarUrl
}
```

**ä¿®æ”¹å**:
```javascript
const updatedUserInfo = {
  ...loginRes,
  user_id: loginRes.id, // æ·»åŠ user_idå­—æ®µï¼Œä½¿ç”¨åç«¯è¿”å›çš„id
  nickname: nickname,
  avatarUrl: avatarUrl
}
```

#### 3. ä¿®å¤profile.jsä¸­çš„saveUserInfoæ–¹æ³•

**ä¿®æ”¹å‰**:
```javascript
const newUserInfo = response.data;
```

**ä¿®æ”¹å**:
```javascript
const newUserInfo = {
  ...response.data,
  user_id: response.data.id // æ·»åŠ user_idå­—æ®µï¼Œä½¿ç”¨åç«¯è¿”å›çš„id
};
```

## æ•°æ®æµåˆ†æ

### ä¿®å¤å‰çš„æ•°æ®æµ

1. **ç”¨æˆ·ä¿å­˜ä¿¡æ¯** â†’ è°ƒç”¨`app.login()`
2. **åç«¯è¿”å›** â†’ `{id: 1, nickname: "ç”¨æˆ·", ...}`
3. **å‰ç«¯ä¿å­˜** â†’ `{id: 1, nickname: "ç”¨æˆ·", ...}` (ç¼ºå°‘user_id)
4. **æ£€æŸ¥ç™»å½•çŠ¶æ€** â†’ `!userInfo.user_id` ä¸º `true`
5. **ç»“æœ** â†’ ä»ç„¶å¼¹å‡ºç™»å½•æµ®çª—

### ä¿®å¤åçš„æ•°æ®æµ

1. **ç”¨æˆ·ä¿å­˜ä¿¡æ¯** â†’ è°ƒç”¨`app.login()`
2. **åç«¯è¿”å›** â†’ `{id: 1, nickname: "ç”¨æˆ·", ...}`
3. **å‰ç«¯ä¿å­˜** â†’ `{id: 1, user_id: 1, nickname: "ç”¨æˆ·", ...}` (åŒ…å«user_id)
4. **æ£€æŸ¥ç™»å½•çŠ¶æ€** â†’ `!userInfo.user_id` ä¸º `false`
5. **ç»“æœ** â†’ æ­£å¸¸è¿›å…¥åˆ›å»ºæˆ¿é—´é¡µé¢

## ç”¨æˆ·ä¿¡æ¯æ•°æ®ç»“æ„

### ä¿®å¤åçš„ç”¨æˆ·ä¿¡æ¯ç»“æ„

```javascript
{
  id: 1,                    // åç«¯è¿”å›çš„åŸå§‹ID
  user_id: 1,               // æ˜ å°„çš„user_idå­—æ®µ
  openid: "mock_openid_1234",
  nickname: "æµ‹è¯•ç”¨æˆ·",
  avatar_url: "https://example.com/avatar.jpg",
  nickName: "æµ‹è¯•ç”¨æˆ·",      // å…¼å®¹å­—æ®µ
  avatarUrl: "https://example.com/avatar.jpg", // å…¼å®¹å­—æ®µ
  created_at: 1694000000,
  updated_at: 1694000000
}
```

### å­—æ®µè¯´æ˜

- **id**: åç«¯æ•°æ®åº“ä¸­çš„ç”¨æˆ·ID
- **user_id**: å‰ç«¯ä½¿ç”¨çš„ç”¨æˆ·IDå­—æ®µ
- **nickname**: åç«¯è¿”å›çš„æ˜µç§°å­—æ®µ
- **nickName**: å‰ç«¯ä½¿ç”¨çš„æ˜µç§°å­—æ®µï¼ˆå…¼å®¹æ€§ï¼‰
- **avatar_url**: åç«¯è¿”å›çš„å¤´åƒURLå­—æ®µ
- **avatarUrl**: å‰ç«¯ä½¿ç”¨çš„å¤´åƒURLå­—æ®µï¼ˆå…¼å®¹æ€§ï¼‰

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯

1. **æ–°ç”¨æˆ·æ³¨å†Œæµç¨‹**:
   - è¾“å…¥æ˜µç§° â†’ ç‚¹å‡»ä¿å­˜
   - éªŒè¯ç”¨æˆ·ä¿¡æ¯æ˜¯å¦æ­£ç¡®ä¿å­˜
   - ç‚¹å‡»åˆ›å»ºæˆ¿é—´ â†’ åº”è¯¥æ­£å¸¸è¿›å…¥åˆ›å»ºæˆ¿é—´é¡µé¢

2. **å¾®ä¿¡æˆæƒæµç¨‹**:
   - ç‚¹å‡»å¾®ä¿¡æˆæƒ â†’ è·å–å¾®ä¿¡ä¿¡æ¯
   - ç‚¹å‡»ä¿å­˜ â†’ éªŒè¯ç”¨æˆ·ä¿¡æ¯æ˜¯å¦æ­£ç¡®ä¿å­˜
   - ç‚¹å‡»åˆ›å»ºæˆ¿é—´ â†’ åº”è¯¥æ­£å¸¸è¿›å…¥åˆ›å»ºæˆ¿é—´é¡µé¢

3. **å·²ç™»å½•ç”¨æˆ·**:
   - é‡æ–°è¿›å…¥å°ç¨‹åº
   - ç‚¹å‡»åˆ›å»ºæˆ¿é—´ â†’ åº”è¯¥ç›´æ¥è¿›å…¥åˆ›å»ºæˆ¿é—´é¡µé¢

### é¢„æœŸç»“æœ

- âœ… ä¿å­˜ç”¨æˆ·ä¿¡æ¯åï¼Œç”¨æˆ·çŠ¶æ€æ­£ç¡®æ›´æ–°
- âœ… ç‚¹å‡»åˆ›å»ºæˆ¿é—´ä¸å†å¼¹å‡ºç™»å½•æµ®çª—
- âœ… æ­£å¸¸è¿›å…¥åˆ›å»ºæˆ¿é—´é¡µé¢
- âœ… ç”¨æˆ·ä¿¡æ¯åœ¨æ‰€æœ‰é¡µé¢ä¸­ä¿æŒä¸€è‡´

## ç›¸å…³æ–‡ä»¶

- âœ… `miniprogram/app.js` - ä¿®å¤loginæ–¹æ³•ä¸­çš„ç”¨æˆ·ä¿¡æ¯ç»“æ„
- âœ… `miniprogram/pages/index/index.js` - ä¿®å¤saveUserInfoæ–¹æ³•
- âœ… `miniprogram/pages/profile/profile.js` - ä¿®å¤saveUserInfoæ–¹æ³•
- âœ… `USER_ID_MAPPING_FIX.md` - ä¿®å¤è¯´æ˜æ–‡æ¡£

## æ€»ç»“

é€šè¿‡ä¿®å¤ç”¨æˆ·IDå­—æ®µæ˜ å°„é—®é¢˜ï¼Œè§£å†³äº†ä¿å­˜ç”¨æˆ·ä¿¡æ¯åä»ç„¶å¼¹å‡ºç™»å½•æµ®çª—çš„é—®é¢˜ï¼š

1. **é—®é¢˜æ ¹æº**: åç«¯è¿”å›`id`å­—æ®µï¼Œå‰ç«¯æ£€æŸ¥`user_id`å­—æ®µ
2. **è§£å†³æ–¹æ¡ˆ**: åœ¨ä¿å­˜ç”¨æˆ·ä¿¡æ¯æ—¶æ·»åŠ `user_id`å­—æ®µæ˜ å°„
3. **ä¿®å¤èŒƒå›´**: app.jsã€index.jsã€profile.jsä¸‰ä¸ªæ–‡ä»¶
4. **ç”¨æˆ·ä½“éªŒ**: ä¿å­˜ç”¨æˆ·ä¿¡æ¯åå¯ä»¥æ­£å¸¸ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½

ä¿®å¤åï¼Œç”¨æˆ·ä¿å­˜ä¿¡æ¯åç‚¹å‡»åˆ›å»ºæˆ¿é—´å°†æ­£å¸¸è¿›å…¥åˆ›å»ºæˆ¿é—´é¡µé¢ï¼Œä¸å†å¼¹å‡ºç™»å½•æµ®çª—ã€‚ğŸ‰
