<!--room.wxml-->
<view class="container">
  <!-- è¿”å›ä¸»é¡µæŒ‰é’® -->
  <view class="back-button" bindtap="goToHome">
    <text class="back-icon">ğŸ </text>
    <text class="back-text">è¿”å›ä¸»é¡µ</text>
  </view>

  <!-- æˆ¿é—´å·åŒºåŸŸ -->
  <view class="room-number-section">
    <view class="room-number-container">
      <text class="room-number-label">æˆ¿é—´å· {{roomInfo.id}}</text>
    </view>
  </view>

  <!-- ç©å®¶ä¿¡æ¯åŒºåŸŸ -->
  <view class="players-section">
    <view wx:if="{{sortedPlayers.length > 0}}" class="players-grid">
      <view 
        wx:for="{{sortedPlayers}}" 
        wx:key="id" 
        class="player-card {{item.user_id === currentUserId ? 'current-player' : ''}}"
        bindtap="quickTransfer"
        data-player="{{item}}"
      >
        <view class="player-avatar-container">
          <image 
            wx:if="{{item.user.avatar_url && !item.avatarError}}" 
            src="{{item.user.avatar_url}}" 
            class="player-avatar" 
            mode="aspectFill"
            binderror="onAvatarError"
            data-index="{{index}}"
          ></image>
          <view wx:else class="player-avatar default-avatar">
            <text class="avatar-icon">ğŸ‘¤</text>
          </view>
        </view>
        <view class="player-name">{{item.user.displayName || item.user.nickname}}</view>
        <view class="player-score {{item.current_score < 0 ? 'score-negative' : ''}}">
          {{item.current_score | formatScore}}
        </view>
      </view>
    </view>
    <view wx:else class="empty-players">
      <view class="empty-icon">ğŸ‘¥</view>
      <view class="empty-text">æš‚æ— ç©å®¶</view>
      <view class="empty-hint">åˆ†äº«æˆ¿é—´é‚€è¯·å¥½å‹åŠ å…¥</view>
    </view>
  </view>

  <!-- å¿«é€Ÿè½¬ç§» -->
  <view wx:if="{{sortedPlayers.length > 0}}" class="transfer-hint">
    <text class="icon">ğŸ‘†</text>
    <text>ç‚¹å‡»ä¸Šæ–¹ç©å®¶å¤´åƒå¿«é€Ÿè½¬ç§»åˆ†æ•°</text>
  </view>
  <!-- æˆ¿é—´æµæ°´ -->
  <view class="history-section">
    <view class="section-title">
      <text class="icon">ğŸ“œ</text>
      <text>æˆ¿é—´æµæ°´</text>
    </view>
    <view wx:if="{{transfers.length > 0}}">
      <view 
        wx:for="{{transfers}}" 
        wx:key="id" 
        class="history-item"
      >
        <view class="transfer-info">
          <view class="transfer-desc">{{item.from_user_name}} â†’ {{item.to_user_name}}</view>
          <view class="transfer-time">{{item.created_at | formatTimestamp}}</view>
        </view>
        <view class="transfer-amount {{item.amount > 0 ? 'positive' : 'negative'}}">
          {{item.amount | formatScore}}
        </view>
      </view>
    </view>
    <view wx:else class="empty-state">
      <text class="icon">ğŸ“</text>
      <text>æš‚æ— è½¬ç§»è®°å½•</text>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-buttons">
    <button class="btn" bindtap="settleRoom">
      <text class="icon">ğŸ§®</text>
      <text>ç»“ç®—æˆ¿é—´</text>
    </button>
    <button class="btn btn-secondary" bindtap="shareRoom">
      <text class="icon">ğŸ“¤</text>
      <text>åˆ†äº«æˆ¿é—´</text>
    </button>
  </view>
</view>

<!-- åˆ†äº«æ¨¡æ€æ¡† -->
<view class="modal {{showShareModal ? 'show' : ''}}" bindtap="hideShareModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">
        <text class="icon">ğŸ“¤</text>
        <text>åˆ†äº«æˆ¿é—´</text>
      </text>
      <text class="close-btn" bindtap="hideShareModal">âœ•</text>
    </view>
    
    <view class="share-room-info">
      <view class="room-header">
        <text class="room-id">æˆ¿é—´å·: {{roomInfo.id}}</text>
        <text class="status-badge status-active">ç­‰å¾…åŠ å…¥</text>
      </view>
      <view class="room-stats">
        <text class="icon">ğŸ‘¥</text>
        <text>{{players.length}}äººï¼ˆæ— äººæ•°é™åˆ¶ï¼‰</text>
      </view>
    </view>

    <view class="qr-code-section">
      <view class="qr-code-header">
        <text class="icon">ğŸ“±</text>
        <text>åˆ†äº«äºŒç»´ç </text>
        <view wx:if="{{qrCodeLoading}}" class="loading-indicator">
          <text class="icon">ğŸ”„</text>
          <text>ç”Ÿæˆä¸­...</text>
        </view>
      </view>
      
      <view wx:if="{{qrCodeData}}" class="qr-code-display">
        <image src="data:image/png;base64,{{qrCodeData}}" class="qr-code-image" mode="aspectFit"></image>
        <view class="qr-code-hint">
          <text class="icon">ğŸ“±</text>
          <text>å¾®ä¿¡æ‰«ç ç›´æ¥è¿›å…¥æˆ¿é—´</text>
        </view>
      </view>
      
      <view wx:else class="qr-code-placeholder">
        <text class="icon">ğŸ“±</text>
        <text>æ­£åœ¨ç”ŸæˆäºŒç»´ç ...</text>
      </view>
    </view>

    <view class="share-actions">
      <button class="btn" open-type="share" data-room-id="{{roomInfo.id}}">
        <text class="icon">ğŸ’¬</text>
        <text>åˆ†äº«ç»™å¥½å‹</text>
      </button>
      <button class="btn btn-secondary" bindtap="copyRoomCode">
        <text class="icon">ğŸ“‹</text>
        <text>å¤åˆ¶æˆ¿é—´å·</text>
      </button>
    </view>

    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideShareModal">
        ç¨ååˆ†äº«
      </button>
    </view>
  </view>
</view>

<!-- ä¸ªäººä¿¡æ¯æµ®çª— -->
<view class="profile-modal" wx:if="{{showProfileModal}}">
  <view class="profile-modal-content" catchtap="stopPropagation">
    <view class="profile-modal-header">
      <text class="profile-modal-title">å®Œå–„ä¸ªäººä¿¡æ¯</text>
      <view class="profile-modal-close" catchtap="hideProfileModal">
        <text class="close-icon">Ã—</text>
      </view>
    </view>
    
    <view class="profile-modal-body">
      <view class="form-group">
        <text class="form-label">æ˜µç§°</text>
        <input 
          class="form-input" 
          type="nickname" 
          placeholder="è¯·è¾“å…¥æ˜µç§°" 
          value="{{profileForm.nickname}}"
          bindinput="onProfileNicknameInput"
          bindblur="onProfileNicknameBlur"
          maxlength="20"
        />
      </view>
      
      <view class="form-group">
        <text class="form-label">å¤´åƒ</text>
        <view class="avatar-section">
          <button class="avatar-upload-btn" open-type="chooseAvatar" bindchooseavatar="onProfileChooseAvatar" hover-class="avatar-btn-hover">
            <image 
              wx:if="{{profileForm.avatarUrl}}" 
              src="{{profileForm.avatarUrl}}" 
              class="avatar-image"
              mode="aspectFill"
            />
            <image 
              wx:else 
              src="/images/default-avatar.png" 
              class="avatar-image"
              mode="aspectFill"
            />
          </button>
          <text class="avatar-hint">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©å¤´åƒ</text>
        </view>
      </view>
    </view>
    
    <view class="profile-modal-footer">
      <button class="cancel-btn" catchtap="hideProfileModal">
        <text class="btn-text">å–æ¶ˆ</text>
      </button>
      <button class="save-btn" catchtap="saveProfileInfo">
        <text class="btn-icon">ğŸ’¾</text>
        <text class="btn-text">ä¿å­˜ä¿¡æ¯</text>
      </button>
    </view>
  </view>
</view>

<!-- ç»“ç®—ç»“æœæµ®çª— -->
<view class="settlement-modal" wx:if="{{showSettlementModal}}">
  <view class="settlement-modal-content" catchtap="stopPropagation">
    <view class="settlement-modal-header">
      <text class="settlement-modal-title">
        <text class="icon">ğŸ’°</text>
        <text>æˆ¿é—´ç»“ç®—</text>
      </text>
      <view class="settlement-modal-close" catchtap="hideSettlementModal">
        <text class="close-icon">Ã—</text>
      </view>
    </view>
    
    <view class="settlement-modal-body">
      <view class="settlement-summary">
        <text class="summary-text">ç»“ç®—æ–¹æ¡ˆï¼ˆ{{settlementData.length}}ç¬”è½¬ç§»ï¼‰</text>
      </view>
      
      <view class="settlement-list">
        <view 
          wx:for="{{settlementData}}" 
          wx:key="index" 
          class="settlement-item"
        >
          <view class="settlement-info">
            <view class="settlement-direction">
              <text class="from-user">{{item.fromUserName}}</text>
              <text class="arrow">â†’</text>
              <text class="to-user">{{item.toUserName}}</text>
            </view>
            <view class="settlement-amount">
              <text class="amount-label">è½¬è´¦é‡‘é¢ï¼š</text>
              <text class="amount-value">{{item.amount}}</text>
            </view>
          </view>
          <view class="settlement-number">{{index + 1}}</view>
        </view>
      </view>
    
    <view class="settlement-modal-footer">
      <button class="confirm-btn" catchtap="hideSettlementModal">
        <text class="btn-icon">âœ…</text>
        <text class="btn-text">æˆ‘çŸ¥é“äº†</text>
      </button>
    </view>
  </view>
</view>
