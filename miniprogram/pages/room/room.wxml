<!--room.wxml-->
<view class="container" 
      bindtouchstart="onTouchStart" 
      bindtouchmove="onTouchMove" 
      bindtouchend="onTouchEnd">
  
  <!-- 统一头部 -->
  <view class="common-header">
    <view class="common-header-left" bindtap="goToHome">
      <text class="back-icon">🏠</text>
      <text class="back-text">主页</text>
    </view>
    <text class="common-header-title">房间 {{roomInfo.id}}</text>
  </view>

  <!-- 玩家信息区域 -->
  <view class="players-section">
    <!-- 已结算房间提示 -->
    <view wx:if="{{roomInfo.status === 2}}" class="settled-room-notice">
      <text class="notice-icon">📊</text>
      <text class="notice-text">房间已结算，显示最终分数</text>
    </view>
    
    <view wx:if="{{sortedPlayers.length > 0}}" class="players-grid">
      <view 
        wx:for="{{sortedPlayers}}" 
        wx:key="id" 
        class="player-card {{item.user_id === currentUserId ? 'current-player' : ''}} {{roomInfo.status === 2 ? 'settled-room' : ''}}"
        bindtap="quickTransfer"
        data-player="{{item}}"
      >
        <view class="player-avatar-container">
          <image 
            wx:if="{{item.user.avatar_url && !item.avatarError}}" 
            src="{{item.user.avatar_url}}" 
            class="player-avatar" 
            mode="aspectFill"
            binderror="onAvatarError"
            data-index="{{index}}"
          ></image>
          <view wx:else class="player-avatar default-avatar">
            <text class="avatar-icon">👤</text>
          </view>
          
          <!-- 头像蒙层提示 - 只对当前用户且昵称为"微信用户"时显示 -->
          <view 
            wx:if="{{item.user_id === currentUserId && showAvatarOverlay}}" 
            class="avatar-overlay"
            catchtap="closeAvatarOverlay"
          >
            <view class="overlay-content">
              <view class="click-hint">
                <text class="hint-text">点击修改信息</text>
                <view class="click-animation">
                  <text class="click-icon">👆</text>
                </view>
              </view>
            </view>
          </view>
        </view>
        <view class="player-name">{{item.user.displayName || item.user.nickname}}</view>
        <view class="player-score {{item.current_score < 0 ? 'score-negative' : ''}}">
          {{item.current_score | formatScore}}
        </view>
      </view>
    </view>
    <view wx:else class="empty-players">
      <view class="empty-icon">👥</view>
      <view class="empty-text">暂无玩家</view>
      <view class="empty-hint">分享房间邀请好友加入</view>
    </view>
  </view>

  <!-- 快速转移 -->
  <view wx:if="{{sortedPlayers.length > 0}}" class="transfer-hint">
    <text class="icon">👆</text>
    <text>点击上方玩家头像快速转移分数</text>
  </view>
  <!-- 房间流水 -->
  <view class="history-section">
    <view class="section-title">
      <text class="icon">📜</text>
      <text>房间流水</text>
    </view>
    <scroll-view class="transfers-scroll" scroll-y="true" enhanced="true" show-scrollbar="false">
      <view wx:if="{{transfers.length > 0}}">
        <view 
          wx:for="{{transfers}}" 
          wx:key="id" 
          class="history-item {{item.from_user_id === currentUserId || item.to_user_id === currentUserId ? 'related' : 'unrelated'}}"
        >
          <view class="transfer-info">
            <view class="transfer-desc">{{item.from_user_name}} → {{item.to_user_name}}</view>
            <view class="transfer-time">{{item.formatted_time}}</view>
          </view>
          <view class="transfer-amount {{item.from_user_id === currentUserId ? 'outgoing' : (item.to_user_id === currentUserId ? 'incoming' : 'neutral')}}">
            {{item.formatted_amount}}
          </view>
        </view>
      </view>
      <view wx:else class="empty-state">
        <text class="icon">📝</text>
        <text>{{roomInfo.status === 2 ? '暂无转移记录' : '暂无转移记录'}}</text>
        <text wx:if="{{roomInfo.status === 2}}" class="empty-hint">房间已结算，显示完整流水</text>
      </view>
    </scroll-view>
  </view>

  <!-- 操作按钮 -->
  <view class="action-buttons">
    <button class="btn" bindtap="settleRoom">
      <text class="icon">{{roomInfo.status === 2 ? '📊' : '🧮'}}</text>
      <text>{{roomInfo.status === 2 ? '查看结算信息' : '结算'}}</text>
    </button>
    <button class="btn btn-secondary" bindtap="shareRoom">
      <text class="icon">📤</text>
      <text>分享</text>
    </button>
  </view>
</view>

<!-- 分享模态框 -->
<view class="modal {{showShareModal ? 'show' : ''}}" bindtap="hideShareModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">
        <text class="icon">📤</text>
        <text>分享房间</text>
      </text>
      <text class="close-btn" bindtap="hideShareModal">✕</text>
    </view>
    
    <view class="share-room-info">
      <view class="room-header">
        <text class="room-id">房间号: {{roomInfo.id}}</text>
        <text class="status-badge status-active">房间号{{roomInfo.id}}</text>
      </view>
      <view class="room-stats">
        <text class="icon">👥</text>
        <text>{{players.length}}人（无人数限制）</text>
      </view>
    </view>

    <view class="qr-code-section">
      <view class="qr-code-header">
        <text class="icon">📱</text>
        <text>分享二维码</text>
        <view wx:if="{{qrCodeLoading}}" class="loading-indicator">
          <text class="icon">🔄</text>
          <text>生成中...</text>
        </view>
      </view>
      
      <view wx:if="{{qrCodeData}}" class="qr-code-display">
        <image src="data:image/png;base64,{{qrCodeData}}" class="qr-code-image" mode="aspectFit"></image>
        <view class="qr-code-hint">
          <text class="icon">📱</text>
          <text>微信扫码直接进入房间</text>
        </view>
      </view>
      
      <view wx:else class="qr-code-placeholder">
        <text class="icon">📱</text>
        <text>正在生成二维码...</text>
      </view>
    </view>

    <view class="share-actions">
      <button class="btn" open-type="share" data-room-id="{{roomInfo.id}}">
        <text class="icon">💬</text>
        <text>分享给好友</text>
      </button>
      <button class="btn btn-secondary" bindtap="copyRoomCode">
        <text class="icon">📋</text>
        <text>复制房间号</text>
      </button>
    </view>

    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideShareModal">
        稍后分享
      </button>
    </view>
  </view>
</view>

<!-- 个人信息浮窗 -->
<view class="profile-modal" wx:if="{{showProfileModal}}">
  <view class="profile-modal-content" catchtap="stopPropagation">
    <view class="profile-modal-header">
      <text class="profile-modal-title">完善个人信息</text>
      <view class="profile-modal-close" catchtap="hideProfileModal">
        <text class="close-icon">×</text>
      </view>
    </view>
    
    <view class="profile-modal-body">
      <view class="form-group">
        <text class="form-label">昵称</text>
        <input 
          class="form-input" 
          type="nickname" 
          placeholder="请输入昵称" 
          value="{{profileForm.nickname}}"
          bindinput="onProfileNicknameInput"
          bindblur="onProfileNicknameBlur"
          maxlength="20"
        />
      </view>
      
      <view class="form-group">
        <text class="form-label">头像</text>
        <view class="avatar-section">
          <button class="avatar-upload-btn" open-type="chooseAvatar" bindchooseavatar="onProfileChooseAvatar" hover-class="avatar-btn-hover">
            <image 
              wx:if="{{profileForm.avatarUrl}}" 
              src="{{profileForm.avatarUrl}}" 
              class="avatar-image"
              mode="aspectFill"
            />
            <image 
              wx:else 
              src="/images/default-avatar.png" 
              class="avatar-image"
              mode="aspectFill"
            />
          </button>
          <text class="avatar-hint">点击上方按钮选择头像</text>
        </view>
      </view>
    </view>
    
    <view class="profile-modal-footer">
      <button class="cancel-btn" catchtap="hideProfileModal">
        <text class="btn-text">取消</text>
      </button>
      <button class="save-btn" catchtap="saveProfileInfo">
        <text class="btn-icon">💾</text>
        <text class="btn-text">保存信息</text>
      </button>
    </view>
  </view>
</view>

<!-- 结算结果浮窗 -->
<view class="settlement-modal" wx:if="{{showSettlementModal}}">
  <view class="settlement-modal-content" catchtap="stopPropagation">
    <view class="settlement-modal-header">
      <text class="settlement-modal-title">
        <text class="icon">💰</text>
        <text>房间结算</text>
      </text>
      <view class="settlement-modal-close" catchtap="hideSettlementModal">
        <text class="close-icon">×</text>
      </view>
    </view>
    
    <view class="settlement-modal-body">
      <view wx:if="{{settlementData && settlementData.length > 0}}">
        <view class="settlement-summary">
          <text class="summary-text">结算方案（{{settlementData.length}}笔转移）</text>
        </view>
        
        <view class="settlement-list">
          <view 
            wx:for="{{settlementData}}" 
            wx:key="index" 
            class="settlement-item"
          >
            <view class="settlement-info">
              <view class="settlement-direction">
                <text class="from-user">{{item.fromUserName}}</text>
                <text class="arrow">→</text>
                <text class="to-user">{{item.toUserName}}</text>
              </view>
              <view class="settlement-amount">
                <text class="amount-label">转账分数：</text>
                <text class="amount-value">{{item.amount}}</text>
              </view>
            </view>
            <view class="settlement-number">{{index + 1}}</view>
          </view>
        </view>
        
        <view class="settlement-hint">
          <text class="icon">💡</text>
          <text>请按照以上顺序进行转移</text>
        </view>
      </view>
      
      <view wx:else class="empty-settlement">
        <text class="icon">📊</text>
        <text class="empty-text">暂无结算方案</text>
        <text class="empty-hint">所有玩家分数已平衡，无需转移</text>
      </view>
    </view>
    
    <view class="settlement-modal-footer">
      <button class="confirm-btn" catchtap="hideSettlementModal">
        <text class="btn-icon">✅</text>
        <text class="btn-text">我知道了</text>
      </button>
    </view>
  </view>
</view>

