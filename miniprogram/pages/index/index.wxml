<!--index.wxml-->
<view class="container">
  <!-- 头部区域 -->
  <view class="header">
    <view class="header-content">
      <view class="header-title">
        <text class="title-icon">🏠</text>
        <text class="title-text">记分助手</text>
      </view>
      <view class="header-avatar" bindtap="goToProfile">
        <image class="avatar-img" src="{{userInfo.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
      </view>
    </view>
  </view>

  <!-- 最近房间区域 -->
  <view class="recent-section {{recentRoom ? 'has-room' : 'no-room'}}">
    <view class="section-title">
      <text class="section-icon">🕐</text>
      <text class="section-text">最近房间</text>
    </view>
    
    <!-- 有最近房间时显示完整卡片 -->
    <view class="recent-room-card" bindtap="enterRecentRoom" wx:if="{{recentRoom}}">
      <view class="room-header">
        <text class="room-id">房间号: {{recentRoom.room_id}}</text>
        <view class="status-badge status-active">进行中</view>
      </view>
      <view class="room-info">
        <view class="room-time">
          <text class="time-icon">📅</text>
          <text class="time-text">{{recentRoom.room_name}}</text>
        </view>
        <view class="room-score">
          <text class="score-icon">💰</text>
          <text class="score-text {{recentRoom.current_score > 0 ? 'positive' : 'negative'}}">{{recentRoom.current_score > 0 ? '+' : ''}}{{recentRoom.current_score}}分</text>
        </view>
      </view>
      <view class="room-stats">
        <text class="stats-icon">👥</text>
        <text class="stats-text">{{recentRoom.player_count}}人参与</text>
        <text class="stats-separator">|</text>
        <text class="stats-icon">🔄</text>
        <text class="stats-text">{{recentRoom.transfer_count}}次转移</text>
      </view>
      <view class="continue-hint">
        <text class="hint-icon">▶️</text>
        <text class="hint-text">点击继续游戏</text>
      </view>
    </view>

    <!-- 没有最近房间时显示简化提示 -->
    <view class="no-recent-room" wx:else>
      <view class="no-room-icon">🏠</view>
      <text class="no-room-text">暂无最近房间</text>
      <text class="no-room-hint">创建或加入房间开始游戏</text>
    </view>

    <view class="history-btn-wrapper">
      <button class="history-btn" bindtap="goToHistory">
        <text class="btn-icon">📋</text>
        <text class="btn-text">查看所有历史房间</text>
      </button>
    </view>
  </view>

  <!-- 分隔线 -->
  <view class="divider"></view>

  <!-- 快速操作区域 -->
  <view class="quick-actions">
    <view class="section-title">
      <text class="section-icon">⚡</text>
      <text class="section-text">快速操作</text>
    </view>
    
    <view class="action-buttons">
      <button class="action-btn primary" bindtap="createRoom">
        <text class="btn-icon">➕</text>
        <text class="btn-text">创建房间</text>
      </button>
      <button class="action-btn secondary" bindtap="joinRoom">
        <text class="btn-icon">📱</text>
        <text class="btn-text">加入房间</text>
      </button>
    </view>
  </view>

  <!-- 登录浮窗 -->
  <view class="login-modal" wx:if="{{showLoginModal}}" catchtap="hideLoginModal">
    <view class="login-modal-content" catchtap="stopPropagation">
      <view class="login-header">
        <text class="login-title">完善个人信息</text>
        <text class="login-close" bindtap="hideLoginModal">✕</text>
      </view>
      
      <view class="login-form">
        <view class="form-item">
          <text class="form-label">昵称</text>
          <input class="form-input" type="nickname" placeholder="请输入昵称" value="{{loginForm.nickname}}" bindinput="onNicknameInput" bindblur="onNicknameBlur" />
        </view>
        
        <view class="form-item">
          <text class="form-label">头像</text>
          <button class="avatar-upload-btn" open-type="chooseAvatar" bindchooseavatar="onChooseAvatar">
            <image class="avatar-preview" src="{{loginForm.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
            <text class="upload-hint">点击选择头像</text>
          </button>
        </view>
      </view>
      
      <view class="login-actions">
        <button class="login-btn wechat" bindtap="authorizeWeChat">
          <text class="btn-icon">🔐</text>
          <text class="btn-text">授权微信信息</text>
        </button>
        <button class="login-btn save" bindtap="saveUserInfo">
          <text class="btn-icon">💾</text>
          <text class="btn-text">保存信息</text>
        </button>
      </view>
    </view>
  </view>

  <!-- 个人信息浮窗 -->
  <view class="profile-modal" wx:if="{{showProfileModal}}">
    <view class="profile-modal-content" catchtap="stopPropagation">
      <view class="profile-modal-header">
        <text class="profile-modal-title">完善个人信息</text>
        <view class="profile-modal-close" catchtap="hideProfileModal">
          <text class="close-icon">×</text>
        </view>
      </view>
      
      <view class="profile-modal-body">
        <view class="form-group">
          <text class="form-label">昵称</text>
          <input 
            class="form-input" 
            type="nickname" 
            placeholder="请输入昵称" 
            value="{{profileForm.nickname}}"
            bindinput="onProfileNicknameInput"
            bindblur="onProfileNicknameBlur"
            maxlength="20"
          />
        </view>
        
        <view class="form-group">
          <text class="form-label">头像</text>
          <view class="avatar-section">
            <button class="avatar-upload-btn" open-type="chooseAvatar" bindchooseavatar="onProfileChooseAvatar" hover-class="avatar-btn-hover">
              <image 
                wx:if="{{profileForm.avatarUrl}}" 
                src="{{profileForm.avatarUrl}}" 
                class="avatar-image"
                mode="aspectFill"
              />
              <image 
                wx:else 
                src="/images/default-avatar.png" 
                class="avatar-image"
                mode="aspectFill"
              />
            </button>
            <text class="avatar-hint">点击上方按钮选择头像</text>
          </view>
        </view>
      </view>
      
      <view class="profile-modal-footer">
        <button class="cancel-btn" catchtap="hideProfileModal">
          <text class="btn-text">取消</text>
        </button>
        <button class="save-btn" catchtap="saveProfileInfo">
          <text class="btn-icon">💾</text>
          <text class="btn-text">保存信息</text>
        </button>
      </view>
    </view>
  </view>

  <!-- 加入房间浮窗 -->
  <view class="join-room-modal" wx:if="{{showJoinRoomModal}}" catchtap="hideJoinRoomModal">
    <view class="join-room-modal-content" catchtap="stopPropagation">
      <view class="join-room-header">
        <text class="join-room-title">加入房间</text>
        <text class="join-room-close" bindtap="hideJoinRoomModal">✕</text>
      </view>
      
      <view class="join-room-body">
        <view class="form-group">
          <text class="form-label">房间号</text>
          <input 
            class="form-input" 
            type="number" 
            placeholder="请输入房间号" 
            value="{{roomCode}}"
            bindinput="onRoomCodeInput"
          />
        </view>
        
        <view class="join-room-hint">
          <text class="hint-icon">💡</text>
          <text class="hint-text">输入房间号即可加入房间</text>
        </view>
      </view>
      
      <view class="join-room-footer">
        <button class="cancel-btn" bindtap="hideJoinRoomModal">
          <text class="btn-text">取消</text>
        </button>
        <button class="confirm-btn" bindtap="confirmJoinRoom">
          <text class="btn-icon">🚪</text>
          <text class="btn-text">加入房间</text>
        </button>
      </view>
    </view>
  </view>
</view>
